# =============================================================================
# SanBud24.pl - Blue-Green Deployment with Azure Slots
# =============================================================================
#
# This workflow implements zero-downtime deployment using Azure deployment slots:
#   1. Deploy to STAGING slot
#   2. Validate staging deployment (health checks)
#   3. Swap STAGING â†’ PRODUCTION (instant, zero downtime)
#   4. Validate production after swap
#   5. Option to rollback if needed
#
# Benefits:
#   - Zero downtime deployments
#   - Instant rollback capability
#   - Pre-production validation
#   - Traffic warming before swap
#
# =============================================================================

name: Deploy with Slots (Blue-Green)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_swap:
        description: 'Deploy to staging only (skip swap to production)'
        required: false
        default: false
        type: boolean
      rollback:
        description: 'Rollback (swap production back to previous version)'
        required: false
        default: false
        type: boolean

env:
  AZURE_WEBAPP_NAME: app-sanbud-api-prod
  RESOURCE_GROUP: rg-sanbud-prod
  SLOT_NAME: staging
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

# =============================================================================
# Rollback Job (Optional)
# =============================================================================
jobs:
  rollback:
    name: ğŸ”„ Rollback Production
    runs-on: ubuntu-latest
    if: github.event.inputs.rollback == 'true'
    environment:
      name: production
    
    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ğŸ”„ Swap slots (Production â† Staging)
        run: |
          echo "âš ï¸  ROLLBACK: Swapping production back to staging version"
          az webapp deployment slot swap \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --slot ${{ env.SLOT_NAME }} \
            --target-slot production
          echo "âœ… Rollback completed"
      
      - name: ğŸ¥ Verify production health
        run: |
          PROD_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "Checking production health after rollback..."
          sleep 10
          
          for i in {1..5}; do
            if curl -f -s "$PROD_URL/health" > /dev/null; then
              echo "âœ… Production is healthy after rollback"
              exit 0
            fi
            echo "Attempt $i/5 failed, waiting..."
            sleep 5
          done
          
          echo "âš ï¸ Production health check failed after rollback"
          exit 1

  # =============================================================================
  # Validation Stage
  # =============================================================================
  validate:
    name: âœ… Validate Code
    runs-on: ubuntu-latest
    if: github.event.inputs.rollback != 'true'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ”§ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ§ª Run tests
        run: |
          pip install pytest pytest-cov
          if [ -d "tests" ]; then
            pytest --cov=app tests/ || echo "âš ï¸ Tests skipped"
          fi

  # =============================================================================
  # Deploy to STAGING Slot
  # =============================================================================
  deploy-to-staging:
    name: ğŸš€ Deploy to Staging Slot
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ğŸ”§ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ“¦ Create deployment package
        run: |
          echo "Creating deployment package for staging..."
          zip -r deployment-staging.zip . \
            -x "*.git*" \
            -x "frontend/*" \
            -x "terraform/*" \
            -x "venv/*" \
            -x "*.pyc" \
            -x "__pycache__/*" \
            -x ".env*" \
            -x "*.log"
          echo "âœ… Package size: $(du -h deployment-staging.zip | cut -f1)"
      
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ğŸš€ Deploy to STAGING slot
        run: |
          echo "Deploying to staging slot: ${{ env.SLOT_NAME }}"
          az webapp deployment source config-zip \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --slot ${{ env.SLOT_NAME }} \
            --src deployment-staging.zip \
            --timeout 600
          echo "âœ… Deployed to staging slot"
      
      - name: ğŸ”„ Restart staging slot
        run: |
          echo "Restarting staging slot..."
          az webapp restart \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --slot ${{ env.SLOT_NAME }}
          echo "âœ… Staging slot restarted"
      
      - name: â³ Wait for staging warmup
        run: |
          echo "Waiting 30 seconds for staging to warm up..."
          sleep 30
      
      - name: ğŸ¥ Validate staging health
        run: |
          STAGING_URL="https://${{ env.AZURE_WEBAPP_NAME }}-${{ env.SLOT_NAME }}.azurewebsites.net"
          echo "Validating staging deployment: $STAGING_URL"
          
          for i in {1..10}; do
            echo "Health check attempt $i/10..."
            if curl -f -s "$STAGING_URL/health" > /dev/null; then
              echo "âœ… Staging is healthy!"
              
              # Test a few more endpoints
              echo "Testing /api/health endpoint..."
              curl -f -s "$STAGING_URL/api/health" || echo "âš ï¸ /api/health not available"
              
              exit 0
            fi
            echo "Not ready yet, waiting 5 seconds..."
            sleep 5
          done
          
          echo "âŒ Staging health check failed after 10 attempts"
          echo "âš ï¸  Deployment will NOT be swapped to production"
          exit 1
      
      - name: ğŸ“Š Staging deployment summary
        if: success()
        run: |
          STAGING_URL="https://${{ env.AZURE_WEBAPP_NAME }}-${{ env.SLOT_NAME }}.azurewebsites.net"
          
          echo "### ğŸ¯ Staging Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Staging URL:** $STAGING_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Health Status:** âœ… Healthy" >> $GITHUB_STEP_SUMMARY
          echo "**Next Step:** Swap to production" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Swap STAGING â†’ PRODUCTION (Blue-Green Switch)
  # =============================================================================
  swap-to-production:
    name: ğŸ”„ Swap to Production
    runs-on: ubuntu-latest
    needs: deploy-to-staging
    if: github.event.inputs.skip_swap != 'true'
    environment:
      name: production
    
    steps:
      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: ğŸ”„ Perform slot swap (Staging â†’ Production)
        run: |
          echo "================================================"
          echo "ğŸš€ SWAPPING SLOTS: STAGING â†’ PRODUCTION"
          echo "================================================"
          echo ""
          echo "This is a zero-downtime operation."
          echo "Current production will move to staging."
          echo "Current staging will become production."
          echo ""
          
          az webapp deployment slot swap \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --slot ${{ env.SLOT_NAME }} \
            --target-slot production \
            --verbose
          
          echo ""
          echo "âœ… Slot swap completed!"
      
      - name: â³ Wait for production stabilization
        run: |
          echo "Waiting 20 seconds for production to stabilize..."
          sleep 20
      
      - name: ğŸ¥ Verify production health
        run: |
          PROD_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          API_URL="https://api.sanbud24.pl"
          
          echo "Verifying production health..."
          echo ""
          
          # Check default Azure URL
          echo "1ï¸âƒ£ Checking $PROD_URL/health"
          for i in {1..5}; do
            if curl -f -s "$PROD_URL/health" > /dev/null; then
              echo "âœ… Production Azure URL is healthy"
              break
            fi
            echo "Attempt $i/5 failed, retrying..."
            sleep 5
          done
          
          # Check custom domain
          echo ""
          echo "2ï¸âƒ£ Checking $API_URL/health"
          if curl -f -s "$API_URL/health" > /dev/null; then
            echo "âœ… Production custom domain is healthy"
          else
            echo "âš ï¸ Custom domain not responding (may need DNS propagation)"
          fi
          
          echo ""
          echo "âœ… Production verification complete"
      
      - name: ğŸ“Š Production swap summary
        run: |
          PROD_URL="https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          STAGING_URL="https://${{ env.AZURE_WEBAPP_NAME }}-${{ env.SLOT_NAME }}.azurewebsites.net"
          
          echo "### ğŸ‰ Production Swap Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** $PROD_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Custom Domain:** https://api.sanbud24.pl" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Version:** Now in staging slot" >> $GITHUB_STEP_SUMMARY
          echo "**Staging URL:** $STAGING_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback:** If needed, swap staging back to production" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Deploy Frontend (Static Web Apps)
  # =============================================================================
  deploy-frontend:
    name: ğŸŒ Deploy Frontend
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: production
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ”§ Install dependencies
        working-directory: ./frontend
        run: npm install
      
      - name: ğŸ—ï¸ Build frontend
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: https://api.sanbud24.pl
          NEXT_PUBLIC_DOMAIN: sanbud24.pl
          NEXT_PUBLIC_SITE_URL: https://sanbud24.pl
        run: npm run build
      
      - name: ğŸš€ Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/frontend"
          output_location: ".next"
          skip_app_build: true
